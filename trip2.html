<!DOCTYPE html>
<html>

<head>
  <title>Profile Capture</title>
  <link rel="stylesheet" href="./trip2.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Fira+Sans:ital@1&family=Poppins:ital,wght@0,300;0,400;1,100&family=Rubik+Puddles&display=swap"
    rel="stylesheet">
</head>

<body>
  <div class="container">
    <h1>Profile Capture</h1>
    <div class="actionbuttons">
      <button id="startButton" class="capture-button">Start Video Stream</button>
      <!-- <button id="captureButton" class="capture-button">Capture Image</button> -->
      <button id="stopButton" class="capture-button">Stop Video Stream</button>
    </div>
    <div id="profilesContainer" class="profiles-container"></div>
    <button id="scrollToTopButton" class="scroll-to-top">&uarr;</button>
  </div>

  <!-- Firebase SDK and JavaScript code here -->
  <script src="https://www.gstatic.com/firebasejs/8.8.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.8.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.8.1/firebase-storage.js"></script>
  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCaQ_5iR5aPm6kBVwhR9Zqg7iQHYUUSh6g",
      authDomain: "myfavurls-6a643.firebaseapp.com",
      projectId: "myfavurls-6a643",
      storageBucket: "myfavurls-6a643.appspot.com",
      messagingSenderId: "312966781114",
      appId: "1:312966781114:web:9dc939a7364a6336014a83",
    };

    // Initialize Firebase
    const app = firebase.initializeApp(firebaseConfig);

    // Reference to Firestore database
    const db = app.firestore();
    const profilesCollection = db.collection('profiles');

    // Reference to Firebase Storage
    const storage = app.storage();

    // DOM elements
    const startButton = document.getElementById('startButton');
    // const captureButton = document.getElementById('captureButton');
    const profilesContainer = document.getElementById('profilesContainer');
    const scrollToTopButton = document.getElementById('scrollToTopButton');
    const stopButton = document.getElementById("stopButton")

    // Add event listener to start the video stream
    startButton.addEventListener('click', e => { startVideoStream('user') });

    // Adding removal of video stream
    stopButton.addEventListener('click', stopVideoStream);

    // Add event listener to capture image
    // captureButton.addEventListener('click', captureImage);

    // Add event listener to scroll to top
    scrollToTopButton.addEventListener('click', scrollToTop);

    // Variables for video stream and captured image
    let videoStream = null;
    let capturedImage = null;
    let is_Video_On = false;

    // stop video stream if exists and remove stream
    function stopVideoStream() {
      if (videoStream) {
        const video_elm = document.getElementById('camera');
        video_elm.srcObject = null;
        is_Video_On = false;
        let captureButton = document.getElementById("captureButton");
        captureButton?.remove();
        videoStream.getTracks().forEach(track => track.stop());
        videoStream = null;
        video_elm.parentElement.remove();
      }
    }

    // Function to start the video stream
    function startVideoStream(cameraPosition) {
      const videoConstraints = {
        video: {
          facingMode: cameraPosition
        }
      };

      // Request access to the webcam
      navigator.mediaDevices.getUserMedia(videoConstraints)
        .then(stream => {
          is_Video_On = true;
          let captureButton = document.createElement("button");
          captureButton.textContent = "Capture Image"
          captureButton.setAttribute("id", "captureButton");
          captureButton.addEventListener("click", captureImage);
          captureButton.classList.add("capture-button");
          let actionbuttons = document.getElementsByClassName("actionbuttons")[0];
          actionbuttons.prepend(captureButton);
          videoStream = stream;
          const streamcontainer = document.createElement('div');
          streamcontainer.classList.add('streamcontainer');
          const streamCameraButtonContainer = document.createElement('div');
          streamCameraButtonContainer.classList.add('streamcameraactionbuttons')
          const selfieElm = document.createElement('span');
          selfieElm.innerText = 'selfie'
          selfieElm.addEventListener('click', e => {
            stopVideoStream();
            startVideoStream('user')
          })
          const backcamElm = document.createElement('span');
          backcamElm.innerText = 'back camera';
          backcamElm.addEventListener('click', e => {
            stopVideoStream();
            startVideoStream('environment')
          })
          streamCameraButtonContainer.appendChild(selfieElm);
          streamCameraButtonContainer.appendChild(backcamElm);
          const cameraElement = document.createElement('video');
          cameraElement.id = 'camera';
          cameraElement.width = '100%';
          cameraElement.height = 'auto';
          cameraElement.autoplay = true;
          cameraElement.playsinline = true;
          cameraElement.style.display = 'block';
          streamcontainer.prepend(cameraElement);
          streamcontainer.appendChild(streamCameraButtonContainer);

          document.body.prepend(streamcontainer);
          cameraElement.srcObject = stream;
        })
        .catch(error => {
          console.error('Error accessing the webcam:', error);
        });
    }

    // Example usage:
    // To access the front camera:
    // startVideoStream('user');

    // To access the back camera:
    // startVideoStream('environment');




    //getting coordinates of images
    function saveWithPosition(profileData) {
      return new Promise((res, rej) => {
        navigator.geolocation.getCurrentPosition(
          position => {
            const { latitude, longitude, accuracy, altitude, altitudeAccuracy, heading, speed } = position.coords;

            profileData.position = {
              latitude,
              longitude,
              accuracy,
              altitude,
              altitudeAccuracy,
              heading,
              speed
            };

            // Save profile data to Firestore
            profilesCollection.add(profileData)
              .then(docRef => {
                res(docRef.id);
              })
              .catch(err => {
                rej(err);
              })
          },
          error => {
            console.error('Error getting user position:', error);

            // Save profile data to Firestore without position
            profilesCollection.add(profileData)
              .then(recId => {
                console.log('doc addeded with ' + recId)
              })
              .catch(err => {
                rej(err);
              })
          }
        );

      })
    }

    // Function to capture image from the video stream
    function captureImage() {
      // Create a canvas element and set its dimensions
      if (!is_Video_On) {
        startVideoStream('user')
      }
      const canvas = document.createElement('canvas');
      const videoElement = document.getElementById('camera');
      const videoWidth = videoElement.videoWidth;
      const videoHeight = videoElement.videoHeight;
      canvas.width = videoWidth;
      canvas.height = videoHeight;

      // Draw the current frame from the video onto the canvas
      const context = canvas.getContext('2d');
      context.drawImage(videoElement, 0, 0, videoWidth, videoHeight);

      // Convert canvas data to base64-encoded JPEG image
      const imageDataURL = canvas.toDataURL('image/jpeg');

      // Save the image to Firebase Storage
      const storageRef = storage.ref();
      const imageName = generateImageName();
      const imageRef = storageRef.child(`images/${imageName}`);
      imageRef.putString(imageDataURL, 'data_url')
        .then(() => {
          // Get the download URL of the saved image
          return imageRef.getDownloadURL();
        })
        .then(downloadURL => {
          //   Create profile data object
          const profileData = {
            locationname: 'John Doe',
            locationstory: 'every picture has its story',
            placeOfPic: null,
            picUrl: downloadURL,
            position: null
          };
          getdataFromLayout(profileData);
        })
        .catch(error => {
          console.error('Error saving the profile:', error);
        });
    }

    // get story  from mic
    function getNarrationStory(micbtn, locationstory) {

      // Speech recognition object
      const recognition = new webkitSpeechRecognition();
      recognition.continuous = false;
      recognition.lang = 'en-US';

      // Event listener to start voice recognition
      micbtn.addEventListener('click', () => {
        micbtn.disabled = true;
        if (micbtn.innerText == 'mic') {
          recognition.start();
        } else {
          // recognition.stop();
        }

      });

      // Event listener for speech recognition result
      recognition.addEventListener('result', event => {
        const speechResult = event.results[event.results.length - 1][0].transcript;
        locationstory.value += speechResult + ' ';
      });

      // Event listener for speech recognition error
      recognition.addEventListener('error', event => {
        console.error('Speech recognition error:', event.error);
      });

      // Event listener for speech recognition end
      recognition.addEventListener('end', () => {
        micbtn.disabled = false;
        recognition.stop();
      });
    }

    // add dark background and get description and name of the location
    function getdataFromLayout(profileData) {
      const layer = document.createElement('div');
      layer.classList.add('blacklayer');
      const formcontainer = document.createElement('div');
      formcontainer.innerHTML = `
       
        <label for="locationname">Location Name:</label>
        <input type = "text" id="locationname">   
       
       
        <label for="locationstory">Locaation description:</label>
        <input type = "textarea" id="locationstory">   
       
        <button id="save">save</button><i id="micbtn" class="material-icons-outlined">
mic_off
</i>`;
      const locationname = formcontainer.querySelector('#locationname');
      const locationstory = formcontainer.querySelector('#locationstory');
      const micbtn = formcontainer.querySelector('#micbtn');

      getNarrationStory(micbtn, locationstory);
      micbtn.addEventListener('click', e => {
        micbtn.disabled = true;
        if (e.target.innerText == 'mic_off') {
          e.target.innerText = 'mic';
        } else {
          e.target.innerText = 'mic_off';
        }
      })
      const savebtn = formcontainer.querySelector('#save');
      savebtn.addEventListener('click', e => {

        if (locationname?.value && locationstory?.value) {
          profileData.locationname = locationname.value;
          profileData.locationstory = locationstory.value;
          layer.remove();
          saveWithPosition(profileData)
            .then(docRef => {
              console.log('Profile saved with ID:' + docRef);
            }).catch(err => {
              console.log("some error" + err)
            })
        } else {
          alert('location name and location story should not be empty');
        }
      });
      layer.appendChild(formcontainer);
      document.body.append(layer);
    }

    // Function to generate a unique image name
    function generateImageName() {
      const timestamp = new Date().getTime();
      const randomNum = Math.floor(Math.random() * 1000);
      return `image_${timestamp}_${randomNum}.jpg`;
    }

    // Function to display profiles from Firestore
    function displayProfiles() {
      profilesContainer.innerHTML = '';

      profilesCollection.get()
        .then(snapshot => {
          snapshot.forEach(doc => {
            const profile = doc.data();
            const profileElement = document.createElement('div');
            profileElement.classList.add('profile');
            profileElement.innerHTML = `
<div class="image-container" id=${doc.id}>
    <span class="remove">remove</span>
    <img src="${profile.picUrl}" alt="Profile Image">
              <h3>${profile.locationname}</h3>
              <p> <strong>story:</strong> ${profile.locationstory}</p>
              <p> <strong>Place of Pic:</strong> ${profile.locationname}</p>
              <section>
                <h4>position</h4>
                <p><strong>lat:</strong>${profile?.position?.latitude} <strong>long:</strong>${profile?.position?.longitude}<p>
                    <p><strong>headding:</strong>${profile?.position?.heading}</p>
                </section>    
</div>
            `;
            profileElement.querySelector(".remove")
              .addEventListener("click", (e) => {
                if (!confirm('are you sure , u want to delete?')) { return }
                e.target.setAttribute("pointer-events", "none")
                const docid = e.target.parentElement.getAttribute("id");
                profileElement.querySelector('.image-container img').src = 'https://media.tenor.com/On7kvXhzml4AAAAj/loading-gif.gif';
                profilesCollection
                  .doc(docid)
                  .delete()
                  .then(() => {
                    console.log("1 document deleted");
                    profileElement.remove();
                  })
                  .catch(e => {
                    e.target.setAttribute("pointer-events", "auto")
                    console.log("error in deleting" + e);
                  });
              })
            profilesContainer.appendChild(profileElement);
          });
        })
        .catch(error => {
          console.error('Error getting profiles:', error);
        });
    }

    // Function to scroll to the top of the page
    function scrollToTop() {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Display profiles on page load
    displayProfiles();
  </script>
</body>

</html>